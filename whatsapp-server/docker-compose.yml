version: "3.9"

services:
  # Account 1â€“20 mit WireGuard
  whatsapp-account-1:
    build:
      context: .
      dockerfile: Dockerfile.wireguard
    container_name: wa-account-1
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ./wireguard-configs/account-1.conf:/etc/wireguard/wg0.conf:ro
      - wa-sessions-1:/app/.wwebjs_auth
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - PORT=3001
      - ACCOUNT_INDEX=1
    ports:
      - "3001:3001"
    networks:
      - wa-network
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 2g
    ulimits:
      nproc: 4096
      nofile:
        soft: 65535
        hard: 65535

  whatsapp-account-2:
    build:
      context: .
      dockerfile: Dockerfile.wireguard
    container_name: wa-account-2
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ./wireguard-configs/account-2.conf:/etc/wireguard/wg0.conf:ro
      - wa-sessions-2:/app/.wwebjs_auth
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - PORT=3002
      - ACCOUNT_INDEX=2
    ports:
      - "3002:3002"
    networks:
      - wa-network
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 2g
    ulimits:
      nproc: 4096
      nofile:
        soft: 65535
        hard: 65535

  whatsapp-account-3:
    build:
      context: .
      dockerfile: Dockerfile.wireguard
    container_name: wa-account-3
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ./wireguard-configs/account-3.conf:/etc/wireguard/wg0.conf:ro
      - wa-sessions-3:/app/.wwebjs_auth
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - PORT=3003
      - ACCOUNT_INDEX=3
    ports:
      - "3003:3003"
    networks:
      - wa-network
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 2g
    ulimits:
      nproc: 4096
      nofile:
        soft: 65535
        hard: 65535

  # ... identisch fortsetzen bis Account 20 ...
  # Nur PORT und ACCOUNT_INDEX anpassen!

  whatsapp-account-20:
    build:
      context: .
      dockerfile: Dockerfile.wireguard
    container_name: wa-account-20
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    volumes:
      - ./wireguard-configs/account-20.conf:/etc/wireguard/wg0.conf:ro
      - wa-sessions-20:/app/.wwebjs_auth
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_KEY=${SUPABASE_KEY}
      - PORT=3020
      - ACCOUNT_INDEX=20
    ports:
      - "3020:3020"
    networks:
      - wa-network
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 2g
    ulimits:
      nproc: 4096
      nofile:
        soft: 65535
        hard: 65535

  # Nginx Reverse Proxy (Load Balancer)
  nginx:
    image: nginx:alpine
    container_name: wa-nginx
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "3000:80"
    depends_on:
      - whatsapp-account-1
      - whatsapp-account-2
      - whatsapp-account-3
      - whatsapp-account-4
      - whatsapp-account-5
      - whatsapp-account-6
      - whatsapp-account-7
      - whatsapp-account-8
      - whatsapp-account-9
      - whatsapp-account-10
      - whatsapp-account-11
      - whatsapp-account-12
      - whatsapp-account-13
      - whatsapp-account-14
      - whatsapp-account-15
      - whatsapp-account-16
      - whatsapp-account-17
      - whatsapp-account-18
      - whatsapp-account-19
      - whatsapp-account-20
    networks:
      - wa-network

volumes:
  wa-sessions-1:
  wa-sessions-2:
  wa-sessions-3:
  wa-sessions-4:
  wa-sessions-5:
  wa-sessions-6:
  wa-sessions-7:
  wa-sessions-8:
  wa-sessions-9:
  wa-sessions-10:
  wa-sessions-11:
  wa-sessions-12:
  wa-sessions-13:
  wa-sessions-14:
  wa-sessions-15:
  wa-sessions-16:
  wa-sessions-17:
  wa-sessions-18:
  wa-sessions-19:
  wa-sessions-20:

networks:
  wa-network:
    driver: bridge
